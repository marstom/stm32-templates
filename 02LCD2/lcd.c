/*
It will be version without SPI
Connection:
3.3V - VCC
GND - GND

PORTC
1 - DC
2 - CE
3 - RST
5 - CLK
7 - DIN

*/

#include "stm32f4_discovery.h"
#include "stm32f4xx_conf.h"



// ports
#define LCD_GPIO GPIOC
#define RCC_AHB1Periph_LCD RCC_AHB1Periph_GPIOC
//pin
#define LCD_DC GPIO_Pin_1
#define LCD_CE GPIO_Pin_2
#define LCD_RST GPIO_Pin_3
#define SCK GPIO_Pin_5  // clk
#define DIN GPIO_Pin_7 // in spi its mosi

#define LCD_DELAY_TIME 2

const unsigned char logo_mini_mono [] = {
0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0x7F, 0x7F, 0x7F, 0xFF, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F,
0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFE, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x7F, 0x3F, 0x0F, 0x03, 0x00, 0x00, 0x00, 0x80, 0xE0, 0x01, 0x01, 0x02, 0x00, 0x04, 0x08, 0xF8,
0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
0xF8, 0xF9, 0xFB, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x7F, 0x1F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x03, 0x00, 0x00, 0x00, 0x00,
0x00, 0xE0, 0x0C, 0x03, 0x03, 0x03, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, 0x03, 0x03,
0x03, 0x81, 0x81, 0x81, 0xC1, 0xC0, 0xC0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x3E, 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFC, 0xFC, 0xFE, 0xFE, 0xFE,
0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC, 0xFC,
0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFE, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F,
};

void delay_ms(uint32_t ms){
  uint32_t sc = (uint32_t)1680 * ms;
  for(uint32_t t=0; t<=sc; t++){
    __NOP();
  }
}

void init_board_leds(){
    GPIO_InitTypeDef GPIO_InitStruct;
    //enable led3
    RCC_AHB1PeriphClockCmd(LED3_GPIO_CLK, ENABLE);
    GPIO_InitStruct.GPIO_Pin = LED3_PIN | LED4_PIN | LED5_PIN | LED6_PIN;
    GPIO_InitStruct.GPIO_Mode = GPIO_Mode_OUT;
    GPIO_InitStruct.GPIO_OType = GPIO_OType_PP;
    GPIO_InitStruct.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_InitStruct.GPIO_PuPd = GPIO_PuPd_NOPULL;
    GPIO_Init(LED3_GPIO_PORT, &GPIO_InitStruct);
    GPIO_SetBits(LED3_GPIO_PORT, LED3_PIN | LED4_PIN | LED5_PIN | LED6_PIN);
}

void init_lcd_pins(){
  GPIO_InitTypeDef GPIO_InitStruct;


  //enable lcd
  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_LCD, ENABLE);
  GPIO_InitStruct.GPIO_Pin = SCK | DIN | LCD_RST | LCD_DC | LCD_CE;
  GPIO_InitStruct.GPIO_Mode = GPIO_Mode_OUT;
  GPIO_InitStruct.GPIO_OType = GPIO_OType_PP;
  GPIO_InitStruct.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStruct.GPIO_PuPd = GPIO_PuPd_NOPULL;
  GPIO_Init(LCD_GPIO, &GPIO_InitStruct);

}

void several_sck(){
  for (uint8_t i = 0; i <= 16; i++)
  {
     GPIO_ResetBits(LCD_GPIO, SCK);
     delay_ms(LCD_DELAY_TIME);
     GPIO_SetBits(LCD_GPIO, DIN);
     delay_ms(LCD_DELAY_TIME);
  }
  
}

uint8_t gpio_send(uint8_t byte){
  // 1 clock tick __-- 1 bit is 01 in clock ticks
  //here set data, check bit state
  for (uint8_t bit_number = 0; bit_number < 8; bit_number++){
    if(byte & (1 << bit_number)){
      GPIO_SetBits(LCD_GPIO, DIN);
    }else{
      GPIO_ResetBits(LCD_GPIO, DIN);
    }
    GPIO_SetBits(LCD_GPIO, SCK);
    delay_ms(1);
    GPIO_ResetBits(LCD_GPIO, SCK);
    delay_ms(1);
  }

  return 0;
}

void lcd_reset(){
  GPIO_ResetBits(LCD_GPIO, LCD_RST); // low
  delay_ms(20);
  GPIO_SetBits(LCD_GPIO, LCD_RST); // high
  delay_ms(20);
  // several_sck();
}

void lcd_cmd(uint8_t cmd){
 GPIO_ResetBits(LCD_GPIO, LCD_DC); // dc low command mode
 delay_ms(20);
 GPIO_ResetBits(LCD_GPIO, LCD_CE); // ce low start transmission
 delay_ms(10);
 gpio_send(cmd);
 GPIO_SetBits(LCD_GPIO, LCD_CE);  // ce high end transmission 
}


void lcd_data(const uint8_t* data, int size){
 GPIO_SetBits(LCD_GPIO, LCD_DC); // dc high data mode
 GPIO_ResetBits(LCD_GPIO, LCD_CE); // ce low start transmission
 delay_ms(20);
 for (int i = 0; i < size; i++){
  gpio_send(data[i]);
 }
 GPIO_SetBits(LCD_GPIO, LCD_CE); // ce high end transmission 
}



int main(){
  init_board_leds();
  init_lcd_pins();
  delay_ms(LCD_DELAY_TIME);
  delay_ms(LCD_DELAY_TIME);
  lcd_reset();
  lcd_cmd(0x21); // basic instruction mode
  lcd_cmd(0x14);
  lcd_cmd(0x80 | 0xaf); //Set contrast
  lcd_cmd(0x20); // extended instruction mode
  lcd_cmd(0x0c);
  lcd_data(logo_mini_mono, sizeof(logo_mini_mono));
  while (1){
    delay_ms(110);
    GPIO_SetBits(LED3_GPIO_PORT, LED3_PIN);
    delay_ms(110);
    GPIO_ResetBits(LED3_GPIO_PORT, LED3_PIN);
    delay_ms(101);
  }
}
